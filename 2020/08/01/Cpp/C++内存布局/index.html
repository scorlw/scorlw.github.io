<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#3367D6"/>
  <link rel="apple-touch-icon" href="/icons-192.png">
  <link rel="manifest" href="/manifest.json">

  

  

  
    <meta name="author" content="scorlw">
  

  

  

  <title>C++内存布局 | scorlw</title>

  

  
    <link rel="icon" href="/xiaoxin.ico">
  

  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
    <link href="https://cdn.bootcss.com/highlight.js/9.15.6/styles/monokai.min.css" rel="stylesheet">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>
<body>
  <div class="root-container">
    <!-- navbar -->
<nav class="navbar">
  <div class="navbar-content">
    <!-- logo -->
    <div class="navbar-logo">
      <a href="/">
        
          scorlw
        
      </a>
    </div>
    <!-- link -->
    <div class="navbar-link">
      <div class="navbar-btn">
        <div></div>
        <div></div>
        <div></div>
      </div>
      <ul class="navbar-list">
        
          <li class="navbar-list-item"><a href="/">HOME</a></li>
        
          <li class="navbar-list-item"><a href="/about">ABOUT</a></li>
        
          <li class="navbar-list-item"><a href="/links">LINK</a></li>
        
          <li class="navbar-list-item"><a href="/tags">TAGS</a></li>
        
          <li class="navbar-list-item"><a href="/categories">CATEGORIES</a></li>
        
      </ul>
    </div>
  </div>
</nav>

    
<!-- header container -->
<header class="header-container post">

  
  

  
  

  
  

  
  

  
  
    <div class="header-content">
      <div class="post-image" style="background-image: url(https://i.loli.net/2020/07/16/9USJAz365ix2LVt.jpg)"></div>
      <div class="post-text">
        <div class="type-wrap">
          <a class="article-category-link" href="/categories/Cpp/">Cpp</a>
        </div>
        <h1 class="title-wrap">C++内存布局</h1>
        <h2 class="title-sub-wrap">
          <strong>scorlw</strong>
          <span>发布于</span>
          
  <a href="javascript:;" class="article-date">
    <time datetime="2020-07-31T16:00:00.000Z" itemprop="datePublished">2020-08-01</time>
  </a>

        </h2>
      </div>
    </div>
  

  
  

  </header>

    <!-- 文章 -->

<!-- 文章内容 -->

<div class="body-container">
  <article class="content-container article-container">
    <div class="article-content">
      
      

      <section class="article-entry">
        <h1 id="C-内存布局"><a href="#C-内存布局" class="headerlink" title="C++内存布局"></a>C++内存布局</h1><blockquote>
<p>c++</p>
</blockquote>
<h1 id="一、字节对齐"><a href="#一、字节对齐" class="headerlink" title="一、字节对齐"></a>一、字节对齐</h1><p>一个基本的对象在内存中占用的内存大小主要为：各字段大小+字节对齐</p>
<h2 id="为什么要字节对齐"><a href="#为什么要字节对齐" class="headerlink" title="为什么要字节对齐"></a>为什么要字节对齐</h2><p>字节对齐的根本原因在于CPU存取数据的效率问题。为了提高效率，计算机从内存中取数据是按照一个固定长度的。比如在32位机上，CPU每次都是取32bit数据的，也就是4字节。</p>
<p>因此如果一个int型整数的起始地址是0x00000004，则它是字节对齐的，一次性从该地址开始取出32bit的数据即为该int的值。</p>
<p>如果一个int型整数的起始地址是0x00000002，则它需要首先取出0x00000002、0x00000003所在的32bit，然后取出0x00000004、0x00000005所在的32bit数据（蓝色的两块），然后将两个32bit拼接在一起来构成该int整数。</p>
<p>可以发现，这样CPU存取数据的效率会变得非常低、 </p>
<h2 id="怎样字节对齐"><a href="#怎样字节对齐" class="headerlink" title="怎样字节对齐"></a>怎样字节对齐</h2><p>具体的字节对齐主要有以下三个准则</p>
<p>1) 结构体变量的首地址能够被其最宽基本类型成员的大小所整除；</p>
<p>2) 结构体每个成员相对于结构体首地址的偏移量都是成员大小的整数倍，eg：char型起始地址能被1整除、short型起始地址能被2整除、int型起始地址能被4整除； </p>
<p>3) 结构体的总大小为结构体最宽基本类型成员大小的整数倍。</p>
<h1 id="二、简单结构体的内存布局"><a href="#二、简单结构体的内存布局" class="headerlink" title="二、简单结构体的内存布局"></a>二、简单结构体的内存布局</h1><p>结构体test定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">test</span>&#123;</span><br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> al;<br>    <span class="hljs-keyword">char</span> ac;<br>    short as;<br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> al2;<br>    <span class="hljs-keyword">char</span> ac2;<br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> al3;<br>    short as2;<br>    <span class="hljs-keyword">int</span> ai;<br>&#125;test;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"sizeof(test) = %d\n"</span>,<span class="hljs-keyword">sizeof</span>(test));<br><br>    test *pt=(test *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(test));<br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt:  "</span>&lt;&lt;<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *&gt;(pt)&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt-&gt;al : "</span>&lt;&lt;<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *&gt;(&amp;(pt-&gt;al))&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt-&gt;ac : "</span>&lt;&lt;<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *&gt;(&amp;(pt-&gt;ac))&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt-&gt;as : "</span>&lt;&lt;<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *&gt;(&amp;(pt-&gt;as))&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt-&gt;al2: "</span>&lt;&lt;<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *&gt;(&amp;(pt-&gt;al2))&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt-&gt;ac2: "</span>&lt;&lt;<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *&gt;(&amp;(pt-&gt;ac2))&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt-&gt;al3: "</span>&lt;&lt;<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *&gt;(&amp;(pt-&gt;al3))&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt-&gt;as2: "</span>&lt;&lt;<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *&gt;(&amp;(pt-&gt;as2))&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt-&gt;ai : "</span>&lt;&lt;<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *&gt;(&amp;(pt-&gt;ai))&lt;&lt;<span class="hljs-built_in">endl</span>;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">sizeof</span>(test) = <span class="hljs-number">48</span><br>pt:  <span class="hljs-number">0x1e4a70</span><br>pt-&gt;al : <span class="hljs-number">0x1e4a70</span><br>pt-&gt;ac : <span class="hljs-number">0x1e4a78</span><br>pt-&gt;as : <span class="hljs-number">0x1e4a7a</span><br>pt-&gt;al2: <span class="hljs-number">0x1e4a80</span><br>pt-&gt;ac2: <span class="hljs-number">0x1e4a88</span><br>pt-&gt;al3: <span class="hljs-number">0x1e4a90</span><br>pt-&gt;as2: <span class="hljs-number">0x1e4a98</span><br>pt-&gt;ai : <span class="hljs-number">0x1e4a9c</span><br></code></pre></td></tr></table></figure>

<p>题外话：在C语言中打印指针可以用p%，eg:printf(“pa=%p\n”,pa);</p>
<p>该结构体中最宽基本类型为long long = 8 字节，因此sizeof(test)=48是8的整数倍；每个long long型成员的起始地址都为8的整数倍、int型的起始地址都为4的整数倍，依次类推。</p>
<p>经过上述分析，可以得到其内存布局如下图所示： </p>
<p><img src="/2020/08/01/Cpp/C++%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/image-20200801214755968.png" alt="image-20200801214755968"></p>
<p>可以发现第二个char型变量ac2只占用一个字节，但它后面的成员是long  long型的，起始地址必须是8的倍数，因此ac2后面的7字节都被浪费掉了，al3从下一个8的倍数开始存放。这样会浪费很多内存，因此我们在设计结构体的时候必须更加谨慎合理，以避免不必要的浪费。</p>
<h1 id="三、C-对象的内存布局"><a href="#三、C-对象的内存布局" class="headerlink" title="三、C++对象的内存布局"></a>三、C++对象的内存布局</h1><h2 id="1、没有继承"><a href="#1、没有继承" class="headerlink" title="1、没有继承"></a>1、没有继承</h2><ul>
<li>无虚函数 = 各字段的大小之和+字节对齐<br> 当C++中一个对象没有继承自其它任何父类，且没有虚函数时，由于类中定义的方法都在方法区，并不在类所在内存中，因此该类型的大小为：<strong>各字段的大小之和+字节对齐</strong>，与C语言中的结构体的内存占用情况完全相同。</li>
<li>有虚函数 = sizeof(vfptr)+各字段大小之和+内存对齐<br> 但是当该类型中含有虚函数时，则还要考虑虚函数表指针vfptr的大小；当一个类中定义了虚函数时，根据C++对象模型可知，该类型的对象就会产生一个虚函数表vtbl，所有定义的虚函数都会依次排放在该虚函数表中，同时在对象的起始位置分配一个虚函数指针vfptr指向vtbl。在32位机器上，指针为4字节，因此当一个类函数虚函数时，它对应的对象所占内存大小为：<strong>sizeof(vfptr)+各字段大小之和+内存对齐</strong>。</li>
</ul>
<p>首先在进行后续的测试前，先了解如何通过vfptr来执行个虚函数</p>
<p>对象的起始地址即为虚函数表的地址， 我们可以通过对象的地址来取得虚函数表的地址，再依次执行各虚函数，如：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span><span class="hljs-params">(*Fun)</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;<br>Test  t;<br>Fun pFun = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"虚函数表地址："</span> &lt;&lt; (<span class="hljs-keyword">int</span>*)(&amp;t) &lt;&lt; <span class="hljs-built_in">endl</span>;<br><span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"虚函数表 — 第一个函数地址："</span> &lt;&lt; (<span class="hljs-keyword">int</span>*)*(<span class="hljs-keyword">int</span>*)(&amp;t) &lt;&lt; <span class="hljs-built_in">endl</span>;<br><br><span class="hljs-keyword">int</span>** pVfptr = (<span class="hljs-keyword">int</span>**)&amp;t;   <span class="hljs-comment">//pVtab为指向虚函数表的指针</span><br>pFun = (Fun)pVfptr[i];   <span class="hljs-comment">//将虚函数表视为一个数组，则pVfptr[i]为第i个虚函数</span><br>pFun();  <span class="hljs-comment">//然后就可以调用该虚函数了</span><br></code></pre></td></tr></table></figure>

<p>有了上述的基础之后，就可以开始后面的测试了</p>
<p>eg：有程序如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt; //auto_ptr的头文件</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> al;<br>    <span class="hljs-keyword">char</span> ac;<br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> al2;<br>    <span class="hljs-keyword">int</span> ai;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ff</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::ff()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">gg</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::gg()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    &#125;<br>&#125;;<br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(*Fun)</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;<br>Test t;<br>Fun pFun = <span class="hljs-literal">NULL</span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"虚函数表地址："</span> &lt;&lt; (<span class="hljs-keyword">int</span> *)(&amp;t) &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"虚函数表 — 第一个函数地址："</span> &lt;&lt; (<span class="hljs-keyword">int</span> *)*(<span class="hljs-keyword">int</span> *)(&amp;t) &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    <br>    Test *pt = <span class="hljs-keyword">new</span> Test();<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"sizeof(test) = %d\n"</span>, <span class="hljs-keyword">sizeof</span>(Test));<br><br>    <span class="hljs-keyword">int</span> **pVtab = (<span class="hljs-keyword">int</span> **)pt;<br>    Fun pFun;<br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"[0] Test::_vptr-&gt;"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; (Fun)pVtab[<span class="hljs-number">0</span>][i] != <span class="hljs-literal">NULL</span>; i++)<br>    &#123;<br>        pFun = (Fun)pVtab[<span class="hljs-number">0</span>][i];<br>        <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"    ["</span> &lt;&lt; i &lt;&lt; <span class="hljs-string">"] "</span>;<br>        pFun();<br>    &#125;<br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"pt-&gt;al  : "</span> &lt;&lt; <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *&gt;(&amp;(pt-&gt;al)) &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"pt-&gt;ac  : "</span> &lt;&lt; <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *&gt;(&amp;(pt-&gt;ac)) &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"pt-&gt;al2 : "</span> &lt;&lt; <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *&gt;(&amp;(pt-&gt;al2)) &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"pt-&gt;ai  : "</span> &lt;&lt; <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *&gt;(&amp;(pt-&gt;ai)) &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    system(<span class="hljs-string">"pause"</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++">虚函数表地址：<span class="hljs-number">0x40c040</span><br>虚函数表 — 第一个函数地址：<span class="hljs-number">0x409940</span><br><span class="hljs-keyword">sizeof</span>(test) = <span class="hljs-number">40</span><br>[<span class="hljs-number">0</span>] Test::_vptr-&gt;<br>    [<span class="hljs-number">0</span>] Test::ff()<br>pt-&gt;al  : <span class="hljs-number">0xd84a78</span><br>pt-&gt;ac  : <span class="hljs-number">0xd84a80</span><br>pt-&gt;al2 : <span class="hljs-number">0xd84a88</span><br>pt-&gt;ai  : <span class="hljs-number">0xd84a90</span><br></code></pre></td></tr></table></figure>

<p>即该对象大小为40字节。</p>
<p>即该对象在内存中的结构为 </p>
<p><img src="/2020/08/01/Cpp/C++%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/image-20200801214731453.png" alt="image-20200801214731453"></p>
<p>可以发现：</p>
<p>- 对象所占内存的大小为8字节的整数倍 </p>
<p> -  vfptr位于对象的起始位置 </p>
<p> - 黑色表示padding，其中padding就占了15字节，因此这种排放方式非常浪费内存。</p>
<h2 id="2、单一继承"><a href="#2、单一继承" class="headerlink" title="2、单一继承"></a>2、单一继承</h2><p>在单一继承中，子类只继承自一个父类，这又可以分为简单直接继承、父类或子类中有虚函数、虚继承等几种情况。</p>
<p>1）简单直接继承（父类、子类都没有虚函数）<br> 这种情况比较简单，父类、子类都没有虚函数，则都没有虚函数表，子类在内存中各成员变量根据其继承和声明顺序依次放在后面，先父类后子类。则子类大小为：<strong>父类各字段大小之和+子类各字段大小之和+字节对齐</strong></p>
<p>父类和子类关系如下： </p>
<p><img src="/2020/08/01/Cpp/C++%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/image-20200801215041736.png" alt="image-20200801215041736"></p>
<p>则其在内存中结构为 </p>
<p><img src="/2020/08/01/Cpp/C++%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/image-20200801215105010.png" alt="image-20200801215105010"></p>
<p>sizeof(Derived) = (4 + 1 + 3) + (4 + 1 + 3)=16;</p>
<p>2）有虚函数（父类或子类中有虚函数）<br>     当父类有虚函数表时，则父类中会有一个vfptr指针指向父类虚函数对应的虚表。当一个子类继承自含有虚函数的父类时，就会继承父类的虚函数，因此子类中也会有vfptr指针指向虚函数表。当子类重写了虚函数时，虚表中对应的虚函数就会被子类重写的函数覆盖。此时子类大小就为：<strong>sizeof(vfptr) + 父类各字段大小之和 + 子类各字段大小之和+字节对齐</strong></p>
<p>eg ： 父子类图如下所示： </p>
<p><img src="/2020/08/01/Cpp/C++%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/image-20200801215143103.png" alt="image-20200801215143103"></p>
<p>则Derived类在内存中的存储结构为： </p>
<p><img src="/2020/08/01/Cpp/C++%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/image-20200801215206631.png" alt="image-20200801215206631"></p>
<p>则sizeof(Derived) = 4 + (4 + 1 + 3) + (4 + 1 + 3)=20，且子类的虚函数表覆盖了父类的ff()方法。</p>
<p>1）vfptr在内存的起始位置。<br> 2）成员变量根据其继承和声明顺序依次放在后面，先父类后子类。<br> 3）在单一的继承中，被overwrite的虚函数在虚函数表中得到了更新，子类新定义的虚函数会增加到虚函数表中。</p>
<h2 id="3、多层继承"><a href="#3、多层继承" class="headerlink" title="3、多层继承"></a>3、多层继承</h2><p>多层继承的分析与上述各例完全相同，一层一层的向下分析即可。</p>
<h2 id="4、多继承"><a href="#4、多继承" class="headerlink" title="4、多继承"></a>4、多继承</h2><p>Java只允许单继承，但是在C++中是可以多继承的，即一个子类同时继承自多个父类。这种情况也可以分为父类都没有虚函数和父类有虚函数两种情况。</p>
<ol>
<li>父类都没有虚函数</li>
</ol>
<p>当所有的父类都没有虚函数时，这种情况比较简单，子类所占内存的大小为：<strong>所有父类所有字段之和+子类所有字段之和+字节对齐</strong><br> eg： </p>
<p><img src="/2020/08/01/Cpp/C++%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/image-20200801215235571.png" alt="image-20200801215235571"></p>
<p>Derived类在内存中的存储结构如下所示： </p>
<p><img src="/2020/08/01/Cpp/C++%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/image-20200801215253035.png" alt="image-20200801215253035"></p>
<p>则sizeof(Derived) = 8+8+8 = 24 字节<br> 成员变量按照继承和声明的顺序排列，依次为ba1、bc1、ba2、bc2、da、dc。</p>
<ol>
<li><p>父类有虚函数</p>
<p>当一个父类有虚函数时，表明那个父类存在虚函数表，因此在那个父类的结构中会包含一个虚函数指针vfptr。而当多个父类中定义了虚函数时，则那些父类中都会包含一个vfptr，并且有虚函数的父类在没有虚函数父类的前面。当子类重写了那些虚函数时，就会在第一个定义了虚函数的父类的虚函数表中覆盖父类定义的虚函数，当子类增加了新的虚函数时，也会将新增的虚函数增加至那个虚函数表中。 </p>
<p><img src="/2020/08/01/Cpp/C++%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/image-20200801215313360.png" alt="image-20200801215313360"></p>
<p>则Derived类在内存中的存储结构示意图为 </p>
<p><img src="/2020/08/01/Cpp/C++%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/image-20200801215332989.png" alt="image-20200801215332989"></p>
<p>sizeof(Derived) = 40字节</p>
<p>可以发现：<br> 1）Base2、Base3 中定义了虚函数，因此出现在Base1的前面<br> 2）子类Derived重写了父类Base2的ff()方法，因此Base2的虚函数表被覆盖了<br> 3）子类新增的虚函数hh()增加到了第一个虚函数表，也就是Base2的虚函数表中</p>
<h2 id="虚继承"><a href="#虚继承" class="headerlink" title="虚继承"></a>虚继承</h2><p>虚继承解决了从不同途径继承的类具有共同基类的问题，使得共同基类只有一份拷贝。解决了二义性的问题，也节省了内存。</p>
<p>虚继承的一般类图如下所示：</p>
<p><img src="/2020/08/01/Cpp/C++%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/20160305171041369" alt="img"></p>
<p>sizeof（Derived） = 40 字节。经过分析，可以得到Derived类在内存中的存储结构示意图为：</p>
<p><img src="/2020/08/01/Cpp/C++%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/20160305171254636" alt="这里写图片描述"></p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><ol>
<li>各部分在内存中的存放顺序为先父类、后子类、最后公共基类，即先存放Base1、Base2，然后是Derived，最后才是Base类</li>
<li>对于虚拟继承，子类中会增加一个vbptr指针，它指向的值要么是0，要么是-4，表示公共基类相对于子类的偏移，也即Base类相对于Derived类的偏移。当Base类中有虚函数时，为-4；否则为0。</li>
<li>在VS编译器中，子类和公共基类之间会通过一个NULL指针分隔开。在其它编译器中可能没有这个字段</li>
</ol>
<p>对于每个类的虚函数表可以依次分析：</p>
<ul>
<li>首先是Base类，Base类的ff()函数首先被Base1覆盖，然后又被Derived类覆盖，Base类的gg()函数并未被覆盖，因此Base类的虚函数表中指向的虚函数分别为：Derived::ff()、Base::gg()。</li>
<li>然后是Base1类，Base1类原本定义了两个虚函数，但是ff()函数是覆盖了父类Base中的函数，因此不在Base1的虚函数表中，只有bf1()。同时子类Derived中新定义了一个hh()虚函数，要插入到内存中的第一个虚函数表，因此会插入到Base1类的虚函数表中，因而Base1类中会有Base1::bf1()、Derived::hh()两个函数</li>
<li>最后是Base2类，只有Base2::bf2()一个虚函数。</li>
</ul>
<p>简单的验证代码如下所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(*Fun)</span> <span class="hljs-params">(<span class="hljs-keyword">void</span> )</span></span>;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Base</span>&#123;</span><br><span class="hljs-keyword">public</span>:<br>    Base():ba(<span class="hljs-number">333</span>)&#123;&#125;<br>    <span class="hljs-keyword">int</span> ba;<br>     <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ff</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"Base::ff()"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    &#125;<br>     <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">gg</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"Base::gg()"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    &#125;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Base1</span>:</span><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">public</span> Base&#123;<br><span class="hljs-keyword">public</span>:<br>    Base1():ba(<span class="hljs-number">11</span>)&#123;&#125;<br>    <span class="hljs-keyword">int</span> ba;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span>  <span class="hljs-keyword">void</span> <span class="hljs-title">ff</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"Base::ff()"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span>  <span class="hljs-keyword">void</span> <span class="hljs-title">Bf1</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"Base::Bf1()"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    &#125;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Base2</span>:</span><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">public</span> Base&#123;<br><span class="hljs-keyword">public</span>:<br>    Base2():ba(<span class="hljs-number">22</span>)&#123;&#125;<br>    <span class="hljs-keyword">int</span> ba;<br>     <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Bf2</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"Base2::Bf2()"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    &#125;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Derived</span>:</span><span class="hljs-keyword">public</span> Base1,<span class="hljs-keyword">public</span> Base2&#123;<br><span class="hljs-keyword">public</span>:<br>    Derived():da(<span class="hljs-number">55</span>)&#123;Base1();Base2();&#125;<br>    <span class="hljs-keyword">int</span> da;<br>     <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ff</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"Derived::ff()"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span>  <span class="hljs-keyword">void</span> <span class="hljs-title">hh</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"Derived::hh()"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    &#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>&#123;<br>    Derived *pt=<span class="hljs-keyword">new</span> Derived();<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"sizeof(Derived) = %d\n"</span>,<span class="hljs-keyword">sizeof</span>(Derived));<br>    <span class="hljs-keyword">int</span> len=<span class="hljs-keyword">sizeof</span>(Derived)/<span class="hljs-number">4</span>;  <br><br>    <span class="hljs-keyword">int</span>** pVtab = (<span class="hljs-keyword">int</span>**)pt;<br>    Fun pFun;   <br><br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt[0] :"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;<br>   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; (Fun)pVtab[<span class="hljs-number">0</span>][i]!=<span class="hljs-literal">NULL</span>; i++)&#123;<br>                pFun = (Fun)pVtab[<span class="hljs-number">0</span>][i];<br>                pFun();<br>    &#125;<br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt[1] :"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"    ["</span>&lt;&lt;<span class="hljs-number">0</span>&lt;&lt;<span class="hljs-string">"] "</span>;<br>    <span class="hljs-built_in">cout</span>&lt;&lt;(<span class="hljs-keyword">int</span>)*pVtab[<span class="hljs-number">1</span>]&lt;&lt;<span class="hljs-built_in">endl</span>;<br><br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt[2] :"</span>&lt;&lt;(<span class="hljs-keyword">int</span>)pVtab[<span class="hljs-number">2</span>]&lt;&lt;<span class="hljs-built_in">endl</span>;<br><br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt[3] :"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; (Fun)pVtab[<span class="hljs-number">3</span>][i]!=<span class="hljs-literal">NULL</span>; i++)&#123;<br>                pFun = (Fun)pVtab[<span class="hljs-number">3</span>][i];<br>                pFun();<br>    &#125;<br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt[4] :"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"    ["</span>&lt;&lt;<span class="hljs-number">0</span>&lt;&lt;<span class="hljs-string">"] "</span>;<br>    <span class="hljs-built_in">cout</span>&lt;&lt;(<span class="hljs-keyword">int</span>)*pVtab[<span class="hljs-number">4</span>]&lt;&lt;<span class="hljs-built_in">endl</span>;<br><br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt[5] :"</span>&lt;&lt;(<span class="hljs-keyword">int</span>)pVtab[<span class="hljs-number">5</span>]&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt[6] :"</span>&lt;&lt;(<span class="hljs-keyword">int</span>)pVtab[<span class="hljs-number">6</span>]&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt[7] :"</span>&lt;&lt;(<span class="hljs-keyword">int</span>)pVtab[<span class="hljs-number">7</span>]&lt;&lt;<span class="hljs-built_in">endl</span>;<br><br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt[8] :"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;<br>    pFun = (Fun)pVtab[<span class="hljs-number">8</span>][<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;(pFun = (Fun)pVtab[<span class="hljs-number">8</span>][i])!=<span class="hljs-literal">NULL</span>;++i)&#123;<br>                pFun();<br>    &#125;<br><br>    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"pt[9] :"</span>&lt;&lt;(<span class="hljs-keyword">int</span>)pVtab[<span class="hljs-number">9</span>]&lt;&lt;<span class="hljs-built_in">endl</span>;<br><br>    system(<span class="hljs-string">"pause"</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>







</li>
</ol>
<blockquote>
<p>原文地址：<a href="https://blog.csdn.net/u012658346/article/details/50775742" target="_blank" rel="noopener">https://blog.csdn.net/u012658346/article/details/50775742</a></p>
</blockquote>

      </section>

      <section class="article-footer">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/" rel="tag">#c++</a></li></ul>
      </section>

      <section class="article-navs">
        
<nav class="card-container card-article-nav">
  <div class="card-wrap">
    
      <div id="article-nav-newer" class="card-item img">
        <article>
          
            <div class="card-cover" style="background-image: url(https://i.loli.net/2020/07/16/aquQ7FKU62hdGlS.jpg)"></div>
          
          <a class="card-link article-nav-link" href="/2020/08/03/Cpp/%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E6%89%80%E5%8D%A0%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F/"></a>
          <strong class="article-nav-caption">Newer</strong>
          <p class="article-nav-title">
            
              C/C++中基本数据类型所占内存大小
            
          </p>
        </article>
      </div>
    
    
      <div id="article-nav-older" class="card-item img">
        <article>
          
            <div class="card-cover" style="background-image: url(https://i.loli.net/2020/07/16/Nh2sTH3djUlf6rC.jpg)"></div>
          
          <a class="card-link article-nav-link" href="/2020/07/29/Cpp/allocator%E7%9A%84%E4%BD%BF%E7%94%A8/"></a>
          <strong class="article-nav-caption">Older</strong>
          <p class="article-nav-title">
            
              allocator的使用
            
          </p>
        </article>
      </div>
    
  </div>
</nav>

      </section>
    </div>
  </article>
</div>

    <!-- footer container -->
<footer id="footer" class="footer">
  <div class="footer-container">
     
    <p>&copy; 2022 <a href="/" target="_blank">scorlw</a></p>

    

    

    <p>Powered by <a href="https://hexo.io" target="_blank" rel="noopener noreferrer">Hexo</a> Theme - <a href="https://github.com/miiiku/flex-block" target="_blank" rel="noopener noreferrer author">flex-block</a></p>
  </div>
</footer>
  </div>

  <div class="back-to-top-fixed">
    <svg class="icon icon-back-to-top" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M725.333333 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8l-213.333333-213.333333c-17.066667-17.066667-17.066667-42.666667 0-59.733333s42.666667-17.066667 59.733333 0l213.333333 213.333333c17.066667 17.066667 17.066667 42.666667 0 59.733333C746.666667 422.4 738.133333 426.666667 725.333333 426.666667z"></path>
  <path d="M298.666667 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8-17.066667-17.066667-17.066667-42.666667 0-59.733333l213.333333-213.333333c17.066667-17.066667 42.666667-17.066667 59.733333 0s17.066667 42.666667 0 59.733333l-213.333333 213.333333C320 422.4 311.466667 426.666667 298.666667 426.666667z"></path>
  <path d="M512 896c-25.6 0-42.666667-17.066667-42.666667-42.666667L469.333333 170.666667c0-25.6 17.066667-42.666667 42.666667-42.666667s42.666667 17.066667 42.666667 42.666667l0 682.666667C554.666667 878.933333 537.6 896 512 896z"></path>
</svg> 
  </div>

  
  


  <!-- aplayer 音频 start -->
  <link rel="stylesheet" href="https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.css">
  <script type="text/javascript" src="https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.js"></script>
  <script type="text/javascript">
    const aplayer = document.querySelectorAll(".aplayer");
    aplayer && initaplayer(aplayer);
    function initaplayer(els) {
      let elsArr = Array.from(els);
      elsArr.forEach(el => {
        new APlayer({
          container: el,
          audio: { ...el.dataset },
          theme: "#b7daff",
          lrcType: 3,
          autoplay: false,
          loop: false,
          mutex: true,
        });
      });
    }
  </script>
  <!-- aplayer 音频 end -->
  

<!-- dplayer 视频 start -->
<script type="text/javascript" src="https://unpkg.com/dplayer@1.25.1/dist/DPlayer.min.js"></script>
<script type="text/javascript">
  const dplayer = document.querySelectorAll(".dplayer");
  dplayer && initDPlayer(dplayer);
  function initDPlayer(els) {
    let elsArr = Array.from(els);
    elsArr.forEach(el => {
      let url = el.dataset.url;
      let cover = el.dataset.cover;
      let subtitle = el.dataset.subtitle;

      let options = {
        container: el,
        video: { url: url, pic: cover },
        theme: "#b7daff",
        autoplay: false,
        loop: false,
        mutex: true,
      }

      if (subtitle) {
        options.subtitle = {
          url: el.dataset.subtitle,
        }
      }
      new DPlayer(options);
    });
  }
</script>
<!-- dplayer 视频 end -->


<!-- waterfall 瀑布流 start -->

<script src="/lib/waterfall.min.js"></script>

<script type="text/javascript">

const waterfalls = document.querySelectorAll(".waterfall-container");

if (waterfalls && waterfalls.length > 0) {
  waterfalls.forEach((waterfall, index) => {
    let cls = "waterfall-container-" + index;
    waterfall.classList.add(cls);
    initWaterfall(cls, waterfall);
  });
}

function initWaterfall(selector, el) {
  const options = {};
  if (Object.keys(el.dataset).length > 0) {
    for (let k in el.dataset) {
      options[k] = el.dataset[k];
    }
  }
  waterfall(`.${selector}`, options);
}
</script>
<!-- waterfall 瀑布流 end -->


  <!-- zoom start -->
  
<script src="/lib/zoom.min.js"></script>

  <script type="text/javascript">
    document.querySelector(".article-content") && zoom(".article-content");
  </script>
  <!-- zoom end -->
  



  


  


  




<script src="/js/script.js"></script>

  
  <!-- 尾部用户自定义相关内容 -->

</body>
</html>